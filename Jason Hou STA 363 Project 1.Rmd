---
title: "STA 363 Project 1"
author: "Jason Hou"
date: '2022-09-12'
output: html_document
---

#Abstract



#Section 1 Introduction and Data


```{r load packages}
library(ggplot2)
library(broom)
library(gridExtra)
library(dplyr)
library(class)
library(tidyverse)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data}
dengue<-read.csv("dengueData.csv")
```

```{r checking}
sum(is.na(dengue))
na.omit(dengue)
```

```{r look, include=FALSE}
glimpse(dengue)
```

#Section 2 KNN
## KNN Example

```{r data set for demo}
knnDemo<-data.frame("dengue_status"= dengue$Y,"Age"= dengue$Age, "Height"= dengue$Height)
```

```{r knn demo loop, eval=FALSE, include=FALSE}
n<-nrow(knnDemo)
set.seed(363663)
demoSelectRow<-sample(1:n,n*0.9,replace = "FALSE")
demoTrain<-knnDemo[demoSelectRow,]
demoTest<-knnDemo[-demoSelectRow,]

true1<-which(demoTest$dengue_status == 1)
true0<-which(demoTest$dengue_status == 0)

ntrue1<-length(true1)
ntrue0<-length(true0)

storeK<-data.frame("K"=rep(NA,50),"GMean"=rep(NA,50))

for(i in 1:50){
  storeK$K[i]<-i
  Kpreds<-knn(demoTrain[,c(2,3)],demoTest[,c(2,3)],k=i,cl=demoTrain$dengue_status)
  sensitivity<-sum(Kpreds[true1] == 1)/ntrue1
  specificity<-sum(Kpreds[true0] == 0)/ntrue0
  storeK$GMean[i]<-sqrt(sensitivity*specificity)
}

knnDemoPlot<-ggplot(storeK,aes(K,GMean))+
  geom_line()+
  labs(caption = paste("Geometric Mean, ReD Line at K=", which.max(storeK$GMean)),title = "Figure 1",y = " ")+
  geom_vline(xintercept = which.max(storeK$GMean),lty = 2,col="red")
knnDemoPlot
#
```





```{r create example sets, include=FALSE}
numb<-nrow(knnDemo)
set.seed(363663)
DemoSubsetRow<-sample(1:numb,numb*0.05,replace = FALSE)
SetForDemo<-knnDemo[DemoSubsetRow,]  
```


```{r knn true demo visuals}
example_data<-data.frame("Age"= rep(NA,1),"Height"=rep(NA,1))
example_data$Age[1]<-8
example_data$Height[1]<-100

SetForDemo<-SetForDemo%>%
  mutate(dengue_status=as.character(dengue_status))
#demoTest<-example_data%>%
 # mutate(dengue_status_test=as.character(dengue_status))
ggplot()+
  geom_point(data = SetForDemo,aes(x=Age,y=Height,col=dengue_status),size=2,alpha=0.9,shape=19)+
  geom_point(data =example_data,aes(x=Age,y=Height),size=2,alpha=0.9,shape=4)
  
  
```
Here we have a data point (a boy iwht height of 100cm and age of 8 year old). We look for the dengue status of the 3 nearest data point respect to this data point on the graph and check their dengue status, then we assign the dengue status that the majority of these 3 data points have as the predicted dengue status of this 8 year-old, 100cm boy. 


##Demo KNN
```{r knn prediction example, eval=FALSE, include=FALSE}

for(j in 1:20){
  Kpreds_sample<-knn(SetForDemo[,c(2,3)],example_data[,c(1,2)],k=j,cl=SetForDemo$dengue_status)
  
}
```



```{r creating actual KNN set and mutate logical var, eval=FALSE, include=FALSE}
knnActual<-dengue
knnActual<-knnActual%>%
  mutate(Flush=as.character(Flush),
        Hepatomegaly=as.character(Hepatomegaly),
        Rash=as.character(Rash))
knnActual<-knnActual%>%
  mutate(Flush = recode(Flush,"TRUE" = "1",
         "FALSE" = "0"),
         Hepatomegaly = recode(Hepatomegaly,"TRUE" = "1",
                               "FALSE" = "0"),
         Rash = recode(Rash,"TRUE" = "1",
                      "FALSE" = "0"))
```


### Split data in to 20% testing and 80% training 

```{r 20-80 split}
q<-nrow(dengue)
set.seed(363663)
manually_select<-sample(1:q,q*0.8,replace = "FALSE")
manual_train<-dengue[manually_select,]
manual_test<-dengue[-manually_select,]
storage8020<-data.frame("Predictions" = rep(NA,1146))
#Find rows with positive and negative result
    true1_split<-which(manual_test$Y == 1)
    true0_split<-which(manual_test$Y == 0)
    
    #Compute the amount of rows corresponding to each result
    ntrue1_split<-length(true1_split)
    ntrue0_split<-length(true0_split)
    
storage_split<-data.frame("K"= rep(NA,50),"GeoMean"= rep(NA,50))

for(t in 1:50){
  storage_split$K[t]<-t
  k_preds_split<-knn(manual_train[,c(2,3,8,9)],manual_test[,c(2,3,8,9)],k=t,cl=manual_train$Y)
  storage8020$Predictions<-as.numeric(as.character(k_preds_split))
  
  
  
  sensitivity_split<-sum(k_preds_split[true1_split] == 1)/ntrue1_split
  #print(sensitivity_split)
  specificity_split<-sum(k_preds_split[true0_split] == 0)/ntrue0_split
  #print(specificity_split)
  storage_split$GeoMean[t]<-sqrt(sensitivity_split*specificity_split)
  #print(storage_split$GeoMean)
}
knitr::kable(table(storage8020$Predictions, manual_test$Y), caption= "Table 1: Confusion Matrix(80% Training & 20% Testing ) ", col = c("Not Dengue", "Dengue"))
```




```{r 80-20 plot}
#Create plot to find the best k for KNN 
knnSplit<-ggplot(storage_split,aes(K,GeoMean))+
  geom_line()+
  labs(caption = paste("Geometric Mean, ReD Line at K=", which.max(storage_split$GeoMean)),title = "Figure 1",y = " ")+
  geom_vline(xintercept = which.max(storage_split$GeoMean),lty = 2,col="red")
knnSplit
```





```{r 10 fold CV determine best k }
n<-nrow(knnActual)
nk<-50
storage<-data.frame("K"=rep(NA,nk),
                    "Sensitivity" = rep(NA,nk),
                    "Specificity" = rep(NA,nk),
                    "GeoMean" = rep(NA,nk))

#Creating pools and set fold for K fold CV
set.seed(363663)
pool<-rep(1:10,573)

fold<-sample(pool,5726,replace = FALSE)

#Outer loop for incrementing k 
for(k in 1:nk){
  storage$K[k]<-k
  
  storage_inner<-data.frame("YHat" = rep(NA,n))
  #Inner loop for 10 fold cv
  for(i in 1:10){
    #Find data in each fold
    infold<-which(fold == i)
    
    #Create training and testing sets
    Train_Dengue<-knnActual[-infold,]
    Test_Dengue<-knnActual[infold,]
    
    #Run Knn
    k_preds<-knn(Train_Dengue[,c(2,3,8,9)],Test_Dengue[,c(2,3,8,9)],k=k,cl=Train_Dengue$Y)
    
    #store results
    storage_inner$YHat[infold]<-as.numeric(as.character(k_preds))
    
    #Find rows with positive and negative result
    true1<-which(Test_Dengue$Y == 1)
    true0<-which(Test_Dengue$Y == 0)
    
    #Compute the amount of rows corresponding to each result
    ntrue1<-length(true1)
    ntrue0<-length(true0)
    #Compute sensitivity and specificity, as well as GeoMean for determining the best value for k

    sensitivity<-sum(k_preds[true1] == 1)/ntrue1
    storage$Sensitivity[k]<-sensitivity
    specificity<-sum(k_preds[true0] == 0)/ntrue0
    storage$Specificity[k]<-specificity
    storage$GeoMean[k]<-sqrt(sensitivity*specificity)
    
  }
  
}

```

```{r find best k}
#Create plot to find the best k for KNN 
knnActualPlot<-ggplot(storage,aes(K,GeoMean))+
  geom_line()+
  labs(caption = paste("Geometric Mean, ReD Line at K=", which.max(storage$GeoMean)),title = "Figure 1",y = " ")+
  geom_vline(xintercept = which.max(storage$GeoMean),lty = 2,col="red")
knnActualPlot
```


```{r using best k to do a knn again k = 35}
set.seed(363663)
#create storage for prediction result
storage_inner_trial<-data.frame("pred"=rep(NA,5726))
#run 10 fold knn with best k value = 35
 for(i in 1:10){
   
   #Find data in each fold
    infold<-which(fold == i)
    
    #Creating Training and testing set
    Train_Dengue<-knnActual[-infold,]
    Test_Dengue<-knnActual[infold,]
    #Run knn
    k_preds_best<-knn(Train_Dengue[,c(2,3,8,9)],Test_Dengue[,c(2,3,8,9)],k=35,cl=Train_Dengue$Y)
    #store result
    storage_inner_trial$pred[infold]<-as.numeric(as.character(k_preds))
    
    
 }
#Compute sensitivity and specificity,formating them
sensitivity2<-sum(k_preds[true1] == 1)/ntrue1
knitr::kable(sensitivity)
specificity2<-sum(k_preds[true0] == 0)/ntrue0

#Create confusion Matrix for the prediction with full dengue set

knitr::kable(table(storage_inner_trial$pred, dengue$Y), caption= "Table 2: Confusion Matrix of Predicting Dengue Status (10 Fold CV & KNN with K = 35)  ", col = c("Not Dengue", "Dengue"))  
```

Age, Daydisease, temperature and BMI are the only four included in the prediction. Body height and weight was dropped from prediction since they are highly correlated with BMI(according to BMI formula)and  would create multicolinearity in the prediction.
         

## Section 3 Logistic Regression 

```{r funcrion for log odd,echo=FALSE}
logodds_plot <- function(data, num_bins, bin_method,
                         x, y, grouping = NULL, reg_formula = y ~ x){
  
  if(is.null(grouping)){
    dat <- data.frame(x = data[,x], 
                      y = data[,y],
                      group = 1)
  } else {
    dat <- data.frame(x = data[,x], 
                      y = data[,y],
                      group = data[,grouping])
  }
  
  if(bin_method == "equal_size"){
    logodds_table <- dat %>%
      drop_na() %>%
      arrange(group, x) %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = rep(1:num_bins,
                       each=ceiling(n()/num_bins))[1:n()]) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                prop = mean(c(obs, 0.5)),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(logodds = log(prop/(1 - prop)))
  } else {
    logodds_table <- dat %>%
      drop_na() %>%
      group_by(group) %>%
      mutate(obs = y,
             bin = cut(x, 
                       breaks = num_bins,
                       labels = F)) %>%
      group_by(bin, group) %>%
      summarize(mean_x = mean(x),
                prop = mean(c(obs, 0.5)),
                num_obs = n()) %>%
      ungroup() %>%
      mutate(logodds = log(prop/(1 - prop)))
  }
  
  if(is.null(grouping)){
    logodds_table %>%
      ggplot(aes(x = mean_x,
                 y = logodds)) +
      geom_point(size=2.5) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x,
           y = "Empirical log odds") +
      theme(text = element_text(size=25))
  } else {
    logodds_table %>%
      ggplot(aes(x = mean_x,
                 y = logodds,
                 color = group,
                 shape = group)) +
      geom_point(size=2.5) +
      geom_smooth(se=F, method="lm", formula = reg_formula) +
      theme_bw() +
      labs(x = x,
           y = "Empirical log odds",
           color = grouping,
           shape = grouping) +
      theme(text = element_text(size=25))
  }
  
}
```

#EDA Checking interaction
```{r }
dengue%>%
  mutate(DayDisease=dengue$DayDisease,
         Skin_condition=as.factor(dengue$Skin))%>%
  logodds_plot(100, "equal_size", x = "DayDisease", y = "Y",reg_formula = y ~ x, grouping = "Skin_condition")

```

```{r converting type}
dengueForCheck<-dengue
dengueForCheck$Y=as.factor(dengueForCheck$Y)
dengueForCheck$Sex=as.factor(dengueForCheck$Sex)

dengueForCheck$Abdo=as.factor(dengueForCheck$Abdo)
dengueForCheck$Muco=as.factor(dengueForCheck$Muco)
dengueForCheck$Skin=as.factor(dengueForCheck$Skin)

```



```{r Vomit and DayDisease}
dengueForCheck%>%
  mutate(Vomiting=as.factor(dengueForCheck$Vomiting))%>%
logodds_plot(100,"equal_size", x ="DayDisease", y = "Y",reg_formula = y ~ x, grouping = "Vomiting")
```

```{r DayDisease Abdominal Pain}
dengueForCheck<-dengueForCheck%>%
  mutate(Abdo=as.factor(dengueForCheck$Abdo))
day_abdo<-logodds_plot(100,"equal_size", x ="DayDisease", y = "Y",reg_formula = y ~ x, grouping = "Abdo",data = dengueForCheck)
day_abdo
```

```{r day and Muco}
dengueForCheck<-dengueForCheck%>%
  mutate(Muco=as.factor(dengueForCheck$Muco))
day_Muco<-logodds_plot(100,"equal_size", x ="DayDisease", y = "Y",reg_formula = y ~ x, grouping = "Muco",data = dengueForCheck)
day_Muco
```
```{r Temp abdo}
dengueForCheck<-dengueForCheck%>%
  mutate(Abdo=as.factor(dengueForCheck$Abdo))
temp_abdo<-logodds_plot(100,"equal_size", x ="Temp", y = "Y",reg_formula = y ~ x, grouping = "Abdo",data = dengueForCheck)
temp_abdo

```


```{r try model}
glm(data=dengue, family = binomial, Y~Sex+Vomiting)
```

