---
title: "STA 363 Lab 5"
author: "Jason Hou"
date: '2022-10-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r get data source}
source("http://www.openintro.org/stat/data/cdc.R")
```



```{r load packages, include=FALSE}
#Load all required packages
library(ggplot2)
library(broom)
library(gridExtra)
library(dplyr)
library(class)
library(tidyverse)
library(gridExtra)
library(leaps)
```

```{r eval=FALSE, include=FALSE}
glimpse(cdc)
```


## Question 1 

*Is this a regression or classification task?*

This is a regression task since the response variable is numeric.

## Question 2 
*Create a box plot of the response variable. Does it seem like anything is unusual? If so, explain what and how you will choose to handle it before analysis.*

```{r create new feature}
cdc$wtchange<- cdc$weight -cdc$wtdesire

```

```{r boxplot}
LossGainBox<-ggplot(data=cdc,aes(x=wtchange))+
  geom_boxplot()+
  ggtitle("Figure 1.Box Plot of Weight Change")
LossGainBox
```

The box plot indicates unusually high and low extreme values in the data set. I would try to remove the extreme and unreasonable values before the analysis in order to handle this issue.

```{r remove extreme values}
cdcSelected<-cdc
#cdcSelected$wtchange=cdcSelected$wtchange[cdcSelected$wtchange > upper_bound]
#upper_bound <- 21+1.5*sd(cdcSelected$wtchange)

cdcSelected<-cdcSelected%>%
  subset(wtchange>-200)


```


## Question 3
*Create an appropriate plot to visualize the relationship between weight and desired weight change. Label your plot Figure 2. Based on shape alone, does LSLR seem like a reasonable choice?*

```{r LSLR check graph}
weight_desiredWt<-ggplot(data=cdcSelected,aes(x=weight,y=wtchange))+
  geom_point()+
  ggtitle("Figure 2. Relationship Between Weight and Desired Weight Change")
weight_desiredWt

```

Based on the shape of the scatter plot alone, LSLR seem like a reasonable choice.

## Question 4
*Write down the population form of the LSLR regression model (so include the error term, no hats) in matrix form in the white space in your Markdown file. This is to help you practice writing matrix notation. Remember that to start an equation you use $ in the white space, and that the R Code help site for our course has examples. Example: $Y = \beta_0 + \beta_1 X + \epsilon$. Hint: To make a symbol bold, you use \boldsymbol{}. To make text bold, you use \mathbf{}.*


$$\widehat{Y}=\boldsymbol{X_D}\boldsymbol{\beta}+\boldsymbol{\epsilon}$$

## Question 5

*Create the needed design matrix for an LSLR model for Y= desired weight change and X = weight and store the result as XD. Show the first few rows of your matrix (head(XD)).*


```{r XD}
X<-cdcSelected[,c("weight")]
XD<-cbind(1,X)
Y<-cdcSelected$wtchange
knitr::kable(head(XD),caption = "Table 1. First Few Rows of Matrix XD")
```

## Question 6
*State the dimensions of Y and the dimensions of XD.*

The dimension of Y is 19988\*1(19988 rows and 1 column). The dimension of XD is 19988\*2(19988 rows and 2 columns).


## Question 7 

$$\boldsymbol{\widehat{\beta}} = (\boldsymbol{X^\mathbf{T}_\mathbf{D}X_\mathbf{D}})^{-1}\boldsymbol{X^\mathbf{T}_\mathbf{D}Y}$$

## Question 8

```{r}
result<-solve(t(XD)%*%XD)%*%t(XD)%*%Y
knitr::kable(result,caption = "Table 2. Result of Matrix(Weight and Desired Weight Change")
```

$$\boldsymbol{\widehat{\beta}}=\matrix{-45.0432700
\\0.3512277}$$

## Question 9

*Based on your LSLR line, find the estimated desired weight change for the 5th individual in the data.*

```{r}
knitr::kable(cdcSelected[5,6],caption = "Table 3. Weight of 5th Individual")
```


$$Estimated\ Desire\ Weight\ Change = -44.820 + 0.350* 150=7.68$$

The estimated desired weight change for the 5th individual of the data is 7.68 lbs.


## Question 10

*Why do we need to remove wtdesire from the data before running BSS? Make sure you remove that column from the data before proceeding.*

```{r}
cdcSelected<-cdcSelected%>%
  select(-c("wtdesire"))
```

We need to remove the wtdesire from the data before running BSS because our response variable is calculated from wtdesire.

## Question 11
*Based on this, how many models do you think we fit in Stage 1 (Step 1) of BSS? Hint: Think carefully here. Some of the variables are categorical with more than two levels.*

We would have 12 models, since some of the categorical variables are having more than 2 levels, and the models will be fitted for all the levels beside the base level. 



## Question 12

*Once we have fit all the models in with two features, how do you think we choose one? Hint: Same as Stage 1 (Step 1).*

We would choose the model with the highest $R^2$ value.


## Question 13

*How many $\beta$ terms are in this full model? In other words, we end with Stage 1 ( Step what) ? Hint: If you are stuck, just fit the model in R and look. You can do this by putting in all the features manually, or using ModelFull <- lm( wtchange ~ . , data = cdc).*

```{r full model}
ModelFull <- lm( wtchange ~ . , data = cdcSelected)
knitr::kable(summary(ModelFull)$coefficients,caption = "Table 4. The Full Model")
```

There are 12 $\beta$ terms in the full model.

## Question 14

*Look at only the categorical features in the data. Using these categorical features only, run the first stage of BSS and call the output BSScat. Remember to change the nvmax part of the code!!! You will notice that nothing seems to happen, as the output has been stored. Let’s look at the $R_{adj}^2$ value of each of these models by using the code summary(BSScat)$adjr2. What is the $R_{adj}^2$ of the model fit with one feature? (This is the first value). With two features? (This is the second value).*

```{r convert data type}
cdcSelected$exerany=as.factor(cdcSelected$exerany)
cdcSelected$hlthplan=as.factor(cdcSelected$hlthplan)
cdcSelected$smoke100=as.factor(cdcSelected$smoke100)

```



```{r bss cat}
BSScat <- regsubsets( Y ~ genhlth + exerany + hlthplan + smoke100 + gender, data = cdcSelected, nvmax = 5, method="exhaustive")
knitr::kable(summary(BSScat)$adjr2,caption = "Table 5. $R_{adj}^2$ of Models with CDC Data Set(Categorical Features")
```

The $R_{adj}^2$ of the model fit with one feature is 0.025. The $R_{adj}^2$ of the model fit with two features is 0.033.

## Question 15

Create a plot to help us see the values of $R_{adj}^2$ for all our models from Stage 1. To do this, you can use code plot(BSScat, scale = "adjr"). Note: You can also use plot(BSScat, scale = "Cp") (which uses Mallows’ Cp) or plot(BSScat, scale = "bic"), if you are wanting to use other metrics in the future.

```{r bss plot}
plot(BSScat, scale = "adjr",main="Figure 3. Adjusted R Square BSS Cat")
```


## Question 16

```{r bsscat summary}
knitr::kable(summary(BSScat)$adjr2,caption = "Table 6. $R_{adj}^2$ of Models With Only Categorical Features")
```

The $R_{adj}^2$ of the model with health Good, heath Fair, gender female and the intercept is 0.0392.



## Question 17

*Use all the possible feature variables (categorical and numeric) and run the first stage of BSS and call the output BSSall. Then, use the code plot(BSSall, scale = "adjr2") to plot the results.*

```{r BSS All}
BSSall<-regsubsets( wtchange ~ exerany + genhlth + hlthplan + smoke100 + gender + height + weight, nvmax = 12, method="exhaustive",data=cdcSelected)
plot(BSSall,scale="adjr",main = "Figure 4. Adjusted R Square BSS All")
knitr::kable(summary(BSSall)$adjr2,caption =  "Table 7. $R_{adj}^2$ of Models With All Features")
```



## Question 18
*Which features are used in the model with the lowest value of $R_{adj}^2$, and what is the value of R2adj for that model?*

The feature used in the model with the lowest value of $R_{adj}^2$ is weight. The value of $R_{adj}^2$ for that model is 0.377.

## Question 19

*Which features are used in the model with the second highest $R_{adj}^2$ ? To figure this out, look at the values for each model. Figure out which of the models (1,2,3, etc) has the desired value. Then, run summary(BSSall)$which[HERE,], where the HERE is replaced with the number of the model you want*

```{r second heighest R2adj}
knitr::kable(summary(BSSall)$which[9,],caption = "Table 8. Features Included in Model With Second Highest $R_{adj}^2$ ")
```

Features used in the model with the second heighest $R_{adj}^2$(the 9th model) are: exerany, genhlthvery good, genhlthgood,genhlthpoor,hlthplan, smoke100, gender, height and weight.

## Question 20

*Based on the results, which features would you choose to use? Explain. There is more than one correct answer here, so make sure you justify your reasoning.*

Based on the results, I would choose to include exerany, genhlthvery good,genhlthpoor, gender, height and weight in as features since these features are included in most of the models based on BSS result.
